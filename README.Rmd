---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# movies-dataset

<!-- badges: start -->

<!-- badges: end -->

The `movies-dataset` repository contains data scraped from <https://letterboxd.com/>

`download/00-get-users.R` creates the `users.rds` file, which contains user-level information on the 7,500 most popular users of all time. The `download/01-update-add-more-users.R` script adds more users to this file.

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
users <- readRDS("download/users.rds")
glimpse(users)
```

The information contain in the `href` variable was then used to scrape ratings-per user with the `download/02-get-ratings-from-users.R` script. This data is stored in the `user_ratings.rds` file.

```{r}
user_ratings <- readRDS("download/user_ratings.rds")
glimpse(user_ratings)
```

`3-get-additional-movie-info.R` creates a variety of datasets.

-   The `metadata.rds` file contains additional information.

```{r}
metadata <- read_rds("download/metadata.rds")
glimpse(metadata)
```

The `crew.rds` file

```{r}
crew <- read_rds("download/crew.rds")
glimpse(crew)
```

The `cast.rds` file.

```{r}
cast <- read_rds("download/cast.rds")
glimpse(cast)
```

The `genre.rds` file.

```{r}
genre <- read_rds("download/genre.rds")
glimpse(genre)
```

The `details.rds` file. This file is slightly more complex because it's stored as a nested data frame---i.e., some movies are made by multiple studios, contain multiple spoken languages, etc.

```{r}
details <- read_rds("download/details.rds")

glimpse(details)
```

The `05-get-movie-histograms.R` scrapes the ratings associated with the full population of users. This creates the `movie_ratings.rds` file.

```{r}
movie_ratings <- read_rds("download/movie_ratings.rds")
glimpse(movie_ratings)
```

Finally, the `06-get-user-following.R` gets the social networks among the users in the sample. This file is weird because the "following" behavior across users varies a lot (although it's not unlike a Twitter network)! In short, the `user_following.rds` files is an edgelist that can be paired with the `users.rds` data on each node.

```{r}
following <- read_rds("download/user_following.rds")
glimpse(following)
```

## Descriptive Statistics

**Number of movies:**

*Note, movies with less than 10 movies were removed.*

```{r}
length(unique(user_ratings$data_film_slug))
```

**Number of users:**

*Note, user with less than 10 movies were removed.*

```{r}
length(unique(user_ratings$href))
```

*Note. As of `r format(Sys.Date(), "%B %d %Y")`, the number of users with data represents `r scales::percent(length(unique(user_ratings$href)) / nrow(users), accuracy = 0.01)` of the total users in our sample. The missing users are probably due to the fact that: (1) they deleted their accounts between sampling and collection, (2) they're active users but don't actually rate movies, or (3) they have only rated movies that are too niche (i.e., no other ten users in the sample rated the same movie).*

**Count of movies rated by users (example):**

```{r movie-raters, message=FALSE, warning=FALSE}
theme_set(theme_light() + theme(strip.background = element_rect(fill = "#5C5C5C")))

user_ratings |> 
  count(data_film_slug) |> 
  ggplot(aes(n)) + 
  geom_histogram(color = "white") + 
  geom_rug(alpha = 1/10) + 
  scale_x_log10(labels = scales::comma) 
```

**Count of ratings by users (example):**

```{r}
user_ratings |> 
  count(href) |> 
  ggplot(aes(n)) + 
  geom_histogram(color = "white") + 
  geom_rug(alpha = 1/10) + 
  scale_x_log10(labels = scales::comma) 
```

**A sample of movie ratings (example):**

```{r movie-ratings, fig.height=10, fig.width=10, message=FALSE, warning=FALSE}
user_ratings |> 
  nest(data = !data_film_slug) |> 
  mutate(n = map_dbl(data, nrow)) |> 
  slice_max(n = 36, order_by = n) |> 
  unnest(cols = "data") |> 
  left_join(select(metadata, data_film_slug, title), by = "data_film_slug") |> 
  mutate(title = fct_reorder(title, -n)) |>
  ggplot(aes(rating)) + 
  geom_bar(width = 1/5) + 
  facet_wrap(~title, ncol = 4) +
  scale_x_continuous(breaks = 1:10, labels = 1:10)
```
**Polarizing movies (example):**

```{r polarizing, fig.height=10, fig.width=10, message=FALSE, warning=FALSE}
polarizing <- user_ratings |> 
  group_by(data_film_slug) |> 
  filter(n() >= 500) |>
  summarize(var = var(rating)) |> 
  slice_max(n = 36, order_by = var)

user_ratings |> 
  filter(data_film_slug %in% polarizing$data_film_slug) |> 
  left_join(select(metadata, data_film_slug, title), by = "data_film_slug") |> 
  mutate(title = fct_reorder(title, .x = rating, .fun = var, .desc = TRUE)) |>
  ggplot(aes(rating)) + 
  geom_bar(width = 1/5) + 
  facet_wrap(~title, ncol = 4) +
  scale_x_continuous(breaks = 1:10, labels = 1:10)
```

**Duration (in mins)**

```{r duration}
metadata |> 
  filter(!is.na(year)) |> 
  mutate(decade = factor(year - (year %% 10))) |> 
  ggplot(aes(decade, duration)) +
  stat_summary(fun.data = mean_se, fun.args = list(mult = 2), pch = 21, size = 1/4)
```

**Cast**

```{r}
cast |> 
  count(actor_href, sort = TRUE)
```

**A sample of western movie posters**

```{r posters}
library(magick)

western <- genre |> 
  filter(genre == "western") |> 
  left_join(metadata)

poster_files <- dir("download/movie-pics", full.names = TRUE)
poster_subset <- glue::glue("download/movie-pics/{western$data_film_id}.jpg")
index <- which(str_detect(poster_files, paste(poster_subset, collapse = "|")))

sample(poster_files[index], 5) |> 
  image_read() |> 
  image_scale("x500") |> 
  image_append()

sample(poster_files[index], 5) |> 
  image_read() |> 
  image_scale("x500") |> 
  image_append()

sample(poster_files[index], 5) |> 
  image_read() |> 
  image_scale("x500") |> 
  image_append()
```

**Relationship between "degree" of users and various features**

```{r}
full_join(
  users,
  count(following, to, name = "degree"),
  by = c("href" = "to")
) |> 
  filter(!is.na(degree)) |> 
  pivot_longer(reviews:likes, names_to = "variable", values_to = "number") |> 
  ggplot(aes(number, degree)) + 
  geom_point() + 
  geom_smooth() +
  scale_y_log10() + 
  scale_x_log10() + 
  facet_wrap(~variable)
```

**How does the rating of movies of our sample of users compare to the overall ratings?**

*Note. I'm only comparing movies with 10 raters or more.*

```{r comparison, warning=FALSE, message=FALSE}
inner_join(
  movie_ratings |>  ## full histogram 
    group_by(data_film_slug) |> 
    summarize(avg = weighted.mean(rating, n)),
  user_ratings |> 
    group_by(data_film_slug) |> 
    summarize(sample_avg = mean(rating), sample_size = n())
) |> 
  ggplot(aes(avg, sample_avg)) + 
  geom_point(aes(color = log10(sample_size)), alpha = 1/2, shape = ".") + 
  geom_smooth(method = "lm") + 
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") + 
  ylim(1, 10) + xlim(1, 10) + 
  theme(legend.position = "bottom") +
  scale_color_viridis_c(option = "mako", direction = -1) +
  scale_x_continuous(breaks = 1:10, labels = 1:10) +
  scale_y_continuous(breaks = 1:10, labels = 1:10)

```

Every movie under the red line of equality was rated lower by the sample of popular users; every movie over the line of equality was rated lower by the full population of users. Looks good!

------------------------------------------------------------------------

*We should also extract network data (i.e., who among the users follows who), but I wouldn't know how to use that...* 

*Note, there's currently an API in beta. We should consider applying for this so that the data becomes "legal."*

-   <https://letterboxd.com/api-beta/>
-   <https://api-docs.letterboxd.com/>
